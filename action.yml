name: "Create avro schema"
description: "Se realiza el an√°lisis en sonarqube para NET"
inputs:
  working_directory:
    description: "directory"
    required: true
  github_token:
    required: true
  AVRO_VERSION:
    requiered: false
    default: 1.11.0
  INPUT:
    requiered: false
    default: schema
  PackageVersion:
    requiered: false
    default: 1.0.0
runs:
  using: "composite"
  steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Download avro results
        uses: actions/download-artifact@v1
        with:
          name: code-coverage-report
          path: ${{ inputs.INPUT }}
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 5.x      
      - name: Get Avro Gen
        run: dotnet tool install Apache.Avro.Tools --version $AVRO_VERSION --global
        shell: bash
      - name: Run AvroGen
        run: avrogen -p ${{ inputs.INPUT }}/schema.avpr lang/csharp/
        shell: bash
      - name: Restore dependencies
        run: dotnet restore
        shell: bash
        working-directory: ${{inputs.working_directory}}
      - name: Build
        run: dotnet build --configuration Release --no-restore
        shell: bash
        working-directory: ${{inputs.working_directory}}
      - name: Pack
        run: dotnet pack -p:PackageVersion=${{ inputs.PackageVersion }} --no-build -c Release -o bin/Release/
        shell: bash
        working-directory: ${{inputs.working_directory}}
      - name: Add NuGet sources
        run: dotnet nuget add source https://nuget.pkg.github.com/architecture-it/index.json --name github
        shell: bash
      - name: Nuget Push on Github
        run: dotnet nuget push --source github --api-key ${{ inputs.github_token }} --skip-duplicate ${{ inputs.working_directory }}/bin/Release/*.nupkg
        shell: bash
        working-directory: ${{ inputs.working_directory }}