name: "Create avro schema"
description: "Se realiza el análisis en sonarqube para NET"
inputs:
  github_token:
    description: "github token"
    required: true
  AVRO_VERSION:
    requiered: false
    default: 1.11.0
  INPUT:
    requiered: false
    default: schema
  OUTPUT:
    requiered: false
    default: struct
  repository:
    requiered: false
    default: architecture-it/integracion-schemas-event-go
  app_name:
    description: "Nombre de la app usado como directorio"
    required: true
  directory_repository:
    requiered: false
    default: repo
  organization:
    requiered: false
    default: 'architecture-it'
  repo:
    requiered: false
    default: 'integracion-schemas-event-go'
runs:
  using: "composite"
  steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - uses: actions/setup-go@v2
        with:
          version: 1.17.7
      - name: Get gogen-avro Tools
        run: go get github.com/actgardner/gogen-avro/v10/cmd/...
        shell: bash

        # Se descarga los archivos avsc del step anterior.
      - name: Download avro results
        uses: actions/download-artifact@v1
        with:
          name: avro-schema
          path: ${{ inputs.INPUT }}
        # Se crea la carpeta donde se guardarán los archivos .go
      - name: Create Folder output
        run: mkdir ${{ inputs.OUTPUT }}
        shell: bash
        # se elimina el archivo que utiliza NET
      - name: Remove Schema.avpr
        shell: bash
        run: rm schemas.avpr
        working-directory: ${{ inputs.INPUT }}
        # se recorre el directorio para construir los archivos .go
      - name: Generate go struct
        env: 
          package: ${{ inputs.app_name }}Events
        run: |
         for file in ./${{ inputs.INPUT }}/*.avsc
         do 
            echo "procesando ... ${file}"
            /home/runner/go/bin/gogen-avro --package=${{ env.package }} ${{ inputs.OUTPUT }} ${file} 
         done 
        shell: bash
        # Se clona el repositorio donde se van a disponibilizar las estructuras
      - name: Checkout Nuget go for verify branch
        uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
          repository: ${{ inputs.repository }}
          token: ${{ inputs.github_token }}
          path: ${{ inputs.directory_repository }}
        # Se elimina el directory de la app para poder reemplazar las estructuras
      - name: Remove directory
        shell: bash
        run: |
         if [ -d "./${{ inputs.app_name }}" ] 
         then
            rm -r ${{ inputs.app_name }}
         fi
        working-directory: ${{ inputs.directory_repository }}
        # Se crea la carpeta
      - name: Create directory
        shell: bash
        run: mkdir ${{ inputs.app_name }}
        working-directory: ${{ inputs.directory_repository }}
        # Se copian las estructuras a la carpeta
      - name: check
        shell: bash
        run: ls
        working-directory: ${{ inputs.OUTPUT }}
      - name: Copy/Create file
        shell: bash
        run: |
          echo "Copying..."
          cp -R ./${{ inputs.OUTPUT }}/* ./${{ inputs.directory_repository }}/${{ inputs.app_name }}
        # Se realiza el push
      - name: Push 
        id: push_directory
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ inputs.github_token }}
        with:
          source-directory: ./${{ inputs.directory_repository }}/
          destination-github-username: ${{ inputs.organization }}
          destination-repository-name: ${{ inputs.repo }}
          user-email: ciberseguridad@andreani.com
          commit-message: add ${{ inputs.app_name }} schemas 
          target-branch: 'main'
      - name: Archive schema avro result
        uses: actions/upload-artifact@v1
        with:
          name: go-packages
          path: ./${{ inputs.OUTPUT }}
