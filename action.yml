name: "Generate a Jira Version"
description: "Generate a Jira Version from PR that follows the conventional commit and Pull Request information"
inputs:
  hook_id:
    description: Hook ID. The id generated with the rule following the url https://automation.atlassian.com/pro/hooks/<HOOK_ID>
    required: true
  version:
    description: The version to be created
    required: true


outputs:
  new-version:
    description: The version of the release
    value: ${{ steps.next-version.outputs.newVersion }}
  previous-version:
    description: The previous version of the release
    value: ${{ steps.next-version.outputs.previousVersion }}

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get the latest tag
      id: latest-tag
      shell: bash
      run: |
        echo "result=$(git tag --sort=-taggerdate | tail -1)" >> $GITHUB_OUTPUT
        # get the name of repo
        echo "repo=$(basename -s .git `git config --get remote.origin.url`)" >> $GITHUB_ENV
    
    - name: Use Jira Automation
      uses: actions/github-script@v7
      with: 
        script: |
          const hookId = '${{ inputs.hook_id }}';
          const resp = await fetch(`https://automation.atlassian.com/pro/hooks/${hookId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              "version": "${{ steps.latest-tag.outputs.repo }}-${{ steps.latest-tag.outputs.result }}"
            }),
          });


        
          
    
